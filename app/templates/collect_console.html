{% extends "base.html" %}
{% block title %}{{ tool }} · {{ scope }} · ReconLens CLI{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-4">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <div class="text-xs uppercase tracking-wide text-slate-500">CLI Runner</div>
      <h1 class="text-xl font-semibold">
        <span class="font-mono text-slate-700">{{ tool }}</span>
        <span class="text-slate-400">·</span>
        <span class="font-mono">{{ scope }}</span>
        {% if tool == 'dirsearch' and host %}
          <span class="text-slate-400">·</span>
          <span class="font-mono text-slate-500">{{ host }}</span>
        {% endif %}
      </h1>
    </div>
    <div class="text-sm">
      <a href="/targets/{{ scope }}" class="text-blue-600 hover:underline">← back to report</a>
    </div>
  </div>

  <!-- Command hint -->
  <div class="text-sm font-medium mb-1">Command (hint):</div>
  <textarea class="input w-full font-mono text-[13px]" rows="3" readonly>
{% if tool == 'gau' -%}
    gau --verbose --o  outputs/{{ scope }}/urls.txt {{ scope }}
{%- elif tool == 'waymore' -%}
    waymore -i {{ scope }} -mode U -oU outputs/{{ scope }}/urls.txt --verbose
{%- elif tool == 'subfinder' -%}
    subfinder -d {{ scope }} -silent -all
{%- elif tool == 'amass' -%}
    amass enum -passive -d {{ scope }}
{%- elif tool == 'findomain' -%}
    findomain --target {{ scope }} --quiet
{%- elif tool == 'build' -%}
    python -m ReconLens --scope {{ scope }} --input outputs/{{ scope }}/urls.txt --out outputs/{{ scope }}
{%- elif tool == 'probe_subdomains' -%}
    python -m ReconLens.tools.probe_subdomains --scope {{ scope }} --input outputs/{{ scope }}/subdomains.txt --outputs outputs/ --concurrency 20 --timeout 8 --prefer-https --if-head-then-get
{%- elif tool == 'probe_module' -%}
        {%-   if module and module|lower == 'subdomains' -%}
    python -m ReconLens.tools.probe_subdomains --scope {{ scope }} --input outputs/{{ scope }}/subdomains.txt --outputs outputs/ --concurrency 20 --timeout 8 --prefer-https --if-head-then-get
        {%-   else -%}
    python -m ReconLens.tools.probe_urls --scope {{ scope }} --module {{ module or 'MODULE_HERE' }} --outputs outputs/
        {%-   endif -%}
{%- elif tool == 'dirsearch' -%}
    dirsearch -u {{ host or 'https://sub.example.com' }} --format=simple --full-url --crawl 0 --random-agent --quiet -w {{wordlist}}
    
{%- else -%}
# unknown tool
{%- endif %}
  </textarea>

  <!-- Controls -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <button id="runBtn"
              class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">
        Run
      </button>
      <button id="cancelBtn"
              class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm"
              disabled>
        Cancel
      </button>
      {% if urls_txt %}
      <a href="/targets/{{ scope }}/download/{{ urls_txt.split('/')[-1] }}"
         class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm"
         title="Download urls.txt">
        Open urls.txt
      </a>
      {% endif %}
      <!-- Running indicator + elapsed -->
      <div id="runIndicator"
           class="hidden items-center gap-2 text-sm text-slate-600 ml-2">
        <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10"
                  stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
        </svg>
        <span>Running…</span>
        <span class="text-slate-400">·</span>
        <span id="elapsed">0s</span>
      </div>
    </div>

    <!-- View mode toggles -->
    <div class="flex items-center gap-2 text-xs">
      <span class="text-slate-500">view:</span>
      <button id="modeWrap"  type="button"
              class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">
        80ch wrap
      </button>
      <button id="modeScroll" type="button"
              class="px-2 py-1 rounded border border-slate-300 hover:bg-slate-50">
        horizontal scroll
      </button>
    </div>
  </div>

  <!-- Target corpus info -->
  <div class="text-xs text-slate-500">
    Target URL corpus:
    <span class="font-mono">{{ corpus_hint or urls_txt or '-' }}</span>
    {% if tool == 'dirsearch' %}
      <span class="mx-2 text-slate-300">|</span>
      Host: <span class="font-mono">{{ host or '-' }}</span>
    {% endif %}
  </div>

  <!-- Console -->
  <div id="termBox"
       class="rounded-lg border bg-black text-slate-100 p-3 max-h-[70vh] overflow-auto">
    <pre id="out"
         class="font-mono text-[13px] leading-snug whitespace-pre-wrap break-words max-w-[80ch]"></pre>
  </div>
</div>

<script>
(function(){
  const scope      = {{ scope|tojson }};
  const tool       = {{ tool|tojson }};
  const moduleName = {{ module|tojson }};
  const hostParam  = {{ (host or "")|tojson }};

  const runBtn     = document.getElementById('runBtn');
  const cancelBtn  = document.getElementById('cancelBtn');
  const outEl      = document.getElementById('out');
  const boxEl      = document.getElementById('termBox');
  const btnWrap    = document.getElementById('modeWrap');
  const btnScroll  = document.getElementById('modeScroll');
  const indEl      = document.getElementById('runIndicator');
  const elapsedEl  = document.getElementById('elapsed');

  let es = null;
  let currentJob = null;
  let timer = null;
  let startedAt = 0;

  function normalizeToolForAPI(t){
    return (t === 'rebuild') ? 'build' : t;
  }

  function apiPath(kind, jobId){
    const t = normalizeToolForAPI(tool);
    let path = `/targets/${encodeURIComponent(scope)}/collect/${encodeURIComponent(t)}`;
    if (kind === 'start')  path += '/start';
    if (kind === 'stream') path += '/stream';
    if (kind === 'cancel') path += '/cancel';

    const u = new URL(path, window.location.origin);
    if (t === 'probe_module' && moduleName) {
      u.searchParams.set('module', moduleName);
    }
    if (t === 'dirsearch' && hostParam) {
      u.searchParams.set('host', hostParam);
    }
    if ((kind === 'stream' || kind === 'cancel') && jobId) {
      u.searchParams.set('job', jobId);
    }
    return u.pathname + (u.search ? u.search : '');
  }

  function append(text){
    outEl.textContent += text;
    boxEl.scrollTop = boxEl.scrollHeight;
  }

  function setRunning(on){
    runBtn.disabled = on;
    cancelBtn.disabled = !on;
    // indicator + timer
    if (on) {
      startedAt = Date.now();
      elapsedEl.textContent = '0s';
      indEl.classList.remove('hidden');
      if (timer) clearInterval(timer);
      timer = setInterval(()=>{
        const s = Math.floor((Date.now() - startedAt)/1000);
        elapsedEl.textContent = s + 's';
      }, 1000);
    } else {
      if (timer) clearInterval(timer);
      indEl.classList.add('hidden');
    }
  }

  function setWrap(){
    outEl.classList.add('whitespace-pre-wrap','break-words','max-w-[80ch]');
    outEl.classList.remove('whitespace-pre','max-w-none');
    boxEl.classList.remove('overflow-x-auto');
    boxEl.classList.add('overflow-auto');
  }
  function setScroll(){
    outEl.classList.add('whitespace-pre','max-w-none');
    outEl.classList.remove('whitespace-pre-wrap','break-words','max-w-[80ch]');
    boxEl.classList.add('overflow-x-auto');
  }
  btnWrap?.addEventListener('click', setWrap);
  btnScroll?.addEventListener('click', setScroll);
  setWrap();

  // Disable run if dirsearch & no host
  function enforceDirsearchHost(){
    if (tool === 'dirsearch') {
      const ok = !!hostParam;
      runBtn.disabled = !ok;
      runBtn.title = ok ? "" : "Host is required (?host=sub.example.com)";
    }
  }
  enforceDirsearchHost();

  async function startJob(){
    if (es) { try { es.close(); } catch(_){} es = null; }
    outEl.textContent = "";
    setRunning(true);

    try{
      const startURL = apiPath('start');
      const startRes = await fetch(startURL, { method: 'POST' });
      if (!startRes.ok){
        append(`[error] Failed to start. HTTP ${startRes.status}\n`);
        setRunning(false);
        return;
      }
      const data = await startRes.json();
      const jobId = data.job_id || data.jobId || null;
      if (!jobId){
        append("[error] No job id returned\n");
        setRunning(false);
        return;
      }
      currentJob = jobId;

      const streamURL = apiPath('stream', jobId);
      es = new EventSource(streamURL);
      es.onmessage = (ev) => {
        if (ev.data === '[[DONE]]'){
          setRunning(false);
          try { es.close(); } catch(_){}
          es = null;
          append("[done] finished\n");
          return;
        }
        append(ev.data + "\n");
      };
      es.onerror = () => {
        append("[error] stream connection lost\n");
        setRunning(false);
        try { es.close(); } catch(_){}
        es = null;
      };
    }catch(err){
      append(`[error] ${err && err.message ? err.message : err}\n`);
      setRunning(false);
    }
  }

  async function cancelJob(){
    if (!currentJob) return;
    try {
      const cancelURL = apiPath('cancel', currentJob);
      await fetch(cancelURL, { method: 'POST' });
    } catch(_){}
    setRunning(false);
    if (es) { try { es.close(); } catch(_){ } es = null; }
    append("[info] cancel requested\n");
  }

  runBtn?.addEventListener('click', startJob);
  cancelBtn?.addEventListener('click', cancelJob);

  // Optional: Ctrl+Enter to run
  document.addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !runBtn.disabled) {
      startJob();
    }
  });
})();
</script>
{% endblock %}
