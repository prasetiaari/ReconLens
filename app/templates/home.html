{% extends "layout/base.html" %}
{% block title %}Targets · ReconLens{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-semibold">Targets</h1>
  <button
    class="btn btn-primary"
    onclick="document.getElementById('addTargetModal').classList.remove('hidden')">
    + Add target
  </button>
</div>

{% if scopes %}
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for s in scopes %}
      <div class="rounded-xl bg-white shadow hover:shadow-md transition p-4" data-scope="{{ s }}">
        <div class="flex items-center justify-between">
          <a href="/targets/{{ s }}" class="text-lg font-medium hover:underline">{{ s }}</a>
          <button
            aria-label="Delete"
            class="rounded-md border px-2 py-1 text-[12px] text-slate-600 hover:bg-rose-50 hover:text-rose-700"
            hx-get="/targets/{{ s }}/delete/confirmation"
            hx-target="#modal-root"
            hx-swap="innerHTML">
            del
          </button>
        </div>
        <a href="/targets/{{ s }}" class="text-sm text-slate-500 hover:underline">open report</a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-slate-600">No targets found in <code>outputs/</code>.</p>
{% endif %}

<!-- Stable modal mount (never removed) -->
<div id="modal-root"></div>

<!-- Modal: Add Target -->
<div id="addTargetModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
  <div class="w-full max-w-lg rounded-xl bg-white shadow-lg">
    <div class="flex items-center justify-between px-5 py-4 border-b">
      <h2 class="text-lg font-semibold">Add Target</h2>
      <button class="text-slate-500 hover:text-slate-700"
              onclick="document.getElementById('addTargetModal').classList.add('hidden')">✕</button>
    </div>

    <form id="addTargetForm"
          class="px-5 py-4 space-y-4"
          hx-post="/targets/api/add"
          hx-target="#addTargetErrors"
          hx-swap="innerHTML"
          hx-headers='{"Accept":"application/json"}'
          onsubmit="return sanitizeScopeAndSubmit(event)">
      <!-- Scope / domain -->
      <div>
        <label class="block text-sm text-slate-600 mb-1">Scope (domain)</label>
        <input id="scopeInput" name="scope"
               class="input w-full"
               placeholder="example.com"
               required
               inputmode="url"
               pattern="^(?=.{1,253}$)(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\\.)+[a-z]{2,}$"
               title="Enter a valid domain, e.g. example.com or sub.example.co.id">
        <p class="text-xs text-slate-500 mt-1">
          Domain only (no http://). Subdomains are allowed.
        </p>
      </div>

      <div id="addTargetErrors" class="text-sm text-rose-600"></div>

      <div class="flex items-center justify-end gap-2 pt-2 border-t">
        <button type="button" class="btn"
                onclick="document.getElementById('addTargetModal').classList.add('hidden')">Cancel</button>
        <button class="btn btn-primary">Create</button>
      </div>
    </form>

    <script>
      function sanitizeScopeAndSubmit(ev){
        const inp = document.getElementById('scopeInput');
        try{
          let v = inp.value.trim();
          if (v.startsWith('http://') || v.startsWith('https://')) {
            const u = new URL(v);
            v = u.hostname;
          }
          v = v.replace(/\/.*$/, ''); // drop any trailing path
          inp.value = v.toLowerCase();
        }catch{}
        document.getElementById('addTargetForm')
          .addEventListener('htmx:afterRequest', function(e){
            const hxRedir = e.detail.xhr.getResponseHeader('HX-Redirect');
            if (hxRedir) { window.location.href = hxRedir; return; }
            if (e.detail.xhr.status === 201) { window.location.reload(); }
          }, { once: true });
        return true;
      }

      // Listen for HX-Trigger from server after deletion and remove the card
      // Your delete endpoint should send: HX-Trigger: {"target-deleted":{"scope":"<scope>"}}
      document.body.addEventListener('target-deleted', (ev) => {
        const scope = ev.detail?.scope;
        if (!scope) return;
        const card = document.querySelector(`[data-scope="${scope}"]`);
        card?.remove();
        // Close modal if still open
        const modalRoot = document.getElementById('modal-root');
        if (modalRoot) modalRoot.innerHTML = '';
      });

      // Optional: close modal when clicking the overlay (uses data attribute from the partial)
      document.addEventListener('click', (e) => {
        if (e.target?.dataset?.modalOverlay === '1') {
          const modalRoot = document.getElementById('modal-root');
          if (modalRoot) modalRoot.innerHTML = '';
        }
      });
    </script>
  </div>
</div>
{% endblock %}
