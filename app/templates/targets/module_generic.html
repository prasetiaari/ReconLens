{% extends "layout/base.html" %}

{% block toolbar %}
  {# for form filters #}
{% endblock %}

{% block content %}
{% set active = module_name %}
{% include "targets/partials/_target_tabs.html" %}

<!-- FILTERS -->
<form id="filters"
      class="grid grid-cols-12 gap-4 items-end mb-4"
      hx-get="{{ page_url }}"
      hx-target="#page"
      hx-select="#page"
      hx-push-url="true"
      hx-include="#page select[name='page_size']">

  <div class="col-span-12 md:col-span-4">
    <label class="block text-sm text-slate-500 mb-1">Search</label>
    <input name="q" value="{{ q|default('') }}" placeholder="substring..." class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-1">
    <label class="block text-sm text-slate-500 mb-1">HTTP Class</label>
    {% set hc = (http_class or '(any)') %}
    <select name="http_class" class="input w-full">
      <option value="(any)" {{ 'selected' if hc in ['(any)','any',''] else '' }}>(any)</option>
      <option value="2xx" {{ 'selected' if hc=='2xx' else '' }}>2xx</option>
      <option value="3xx" {{ 'selected' if hc=='3xx' else '' }}>3xx</option>
      <option value="4xx" {{ 'selected' if hc=='4xx' else '' }}>4xx</option>
      <option value="5xx" {{ 'selected' if hc=='5xx' else '' }}>5xx</option>
    </select>
  </div>
  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">HTTP Method</label>
    {% set mf = (method_filter or '(any)') %}
    <select name="method" class="input w-full">
      {% for opt in ['(any)','GET','POST','PUT','PATCH','DELETE','HEAD','OPTIONS'] %}
        <option value="{{ opt }}" {{ 'selected' if opt==mf else '' }}>{{ opt }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Exact Codes</label>
    <input name="codes" value="{{ codes|default('') }}" placeholder="comma-separated, overrides class" class="input w-full"/>
  </div>

  <div class="col-span-12 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Content-Type contains</label>
    <input name="ctype" value="{{ ctype|default('') }}" placeholder="e.g. pdf,msword,zip" class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Min Size (bytes)</label>
    <input type="number" name="min_size" value="{{ min_size if min_size is not none else '' }}" class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Max Size (bytes)</label>
    <input type="number" name="max_size" value="{{ max_size if max_size is not none else '' }}" class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Scheme</label>
    {% set sch = (scheme or '(any)') %}
    <select name="scheme" class="input w-full">
      <option value="(any)" {{ 'selected' if sch in ['(any)','any',''] else '' }}>(any)</option>
      <option value="http"  {{ 'selected' if sch=='http' else '' }}>http</option>
      <option value="https" {{ 'selected' if sch=='https' else '' }}>https</option>
    </select>
  </div>

  <!-- NEW: Subdomain filter -->
  <div class="col-span-12 md:col-span-4">
    <label class="block text-sm text-slate-500 mb-1">Subdomain (host)</label>
    <select name="host" class="input w-full">
      <option value="" {{ 'selected' if not host_filter else '' }}>(any)</option>
      {% for h in host_options or [] %}
        <option value="{{ h }}" {{ 'selected' if host_filter==h else '' }}>{{ h }}</option>
      {% endfor %}
    </select>
    {% if host_options_more %}
      <div class="mt-1 text-xs text-slate-500">+{{ host_options_more }} more… start typing in Search to narrow down.</div>
    {% endif %}
  </div>

  <div class="col-span-6 md:col-span-2 flex gap-3">
    <button class="btn btn-primary mt-6" type="submit">Apply</button>
    <a class="btn mt-6" href="{{ page_url }}">Reset</a>
  </div>
</form>

<!-- PAGE CONTAINER (htmx swaps this) -->
<div id="page"
     class="space-y-4"
     hx-boost="true"
     hx-target="#page"
     hx-select="#page"
     hx-include="#filters"
     hx-push-url="true">

  {% set total_pages = pages %}
  {% set current_page = page %}
  {% set page_size = limit %}
  {% include "components/_pager.html" %}

  <!-- untuk tombol reprobe/redirsearch/-->
<div class="col-span-6 md:col-span-2 flex gap-3 items-end justify-end">
{# mapping untuk partial #}
{% set module = (module_name or module)|lower %}
{% set lines = total %}
{% set host_options = (discovery_host_options if discovery_host_options else host_options) %}

{% include "components/_module_probe_modal.html" %}
</div>

  <div class="overflow-x-auto rounded border bg-white">
    <table class="w-full table-fixed border-separate border-spacing-0 rounded-xl overflow-hidden">
      <thead class="bg-slate-100 text-slate-700">
        <tr class="bg-slate-100 text-slate-600 text-sm">
          <th class="px-4 py-2 text-left w-[36ch]">URL</th>
          <th class="px-12 py-2 text-left">method</th>  {# was: status #}
          <th class="px-4 py-2 text-left">code</th>
          <th class="px-4 py-2 text-left">size</th>
          <th class="p-3 text-left max-w-[20ch]">title</th>
          <th class="px-4 py-2 text-left">last_probe</th>
          <th class="px-4 py-2 text-left">action</th>
        </tr>
      </thead>
      <tbody>
        {% include "targets/partials/_module_generic_rows.html" %}
      </tbody>
    </table>
  </div>

  {% include "components/_pager.html" %}
</div>

<!-- Keep filters in pager links -->
<script>
    document.addEventListener('click', function (e) {
      const btn = e.target.closest && e.target.closest('.btn-open');
      if (!btn) return;
      const url = btn.getAttribute('data-url');
      const method = (btn.getAttribute('data-method') || 'GET').toUpperCase();
      openWithMethod(url, method);
    });

    function openWithMethod(url, method) {
  method = (method || 'GET').toUpperCase();
  if (!url) {
    console.warn('openWithMethod: no url'); return;
  }
  if (method === 'GET') {
    window.open(url, '_blank', 'noopener');
    return;
  }
  // HTML forms officially support only GET/POST. For other methods you may fallback to POST.
  const supported = ['GET','POST'];
  if (!supported.includes(method)) {
    // fallback to POST with _method if you want, or just use POST
    method = 'POST';
  }

  const form = document.createElement('form');
  form.method = method;
  form.action = url;
  form.target = '_blank';
  form.style.display = 'none';
  document.body.appendChild(form);
  form.submit();
  setTimeout(()=>form.remove(), 1000);
}
(function () {
    function openWithMethod(url, method) {
  method = (method || 'GET').toUpperCase();
  try {
    // Basic validation
    if (!url || typeof url !== 'string') {
      console.warn('openWithMethod: invalid url', url);
      return;
    }

    if (method === 'GET') {
      // open as GET in new tab
      window.open(url, '_blank', 'noopener');
      return;
    }

    // For non-GET methods, create & submit a form to open result in new tab
    const form = document.createElement('form');
    form.method = method;         // "POST", "PUT", ...
    form.action = url;
    form.target = '_blank';      // open in new tab/window
    form.style.display = 'none';

    // If you want to supply a body (e.g., JSON or form fields), you can add hidden inputs here.
    // For now we submit empty body (typical for many endpoints that accept POST without body)
    // Example to add hidden field:
    // const input = document.createElement('input');
    // input.type = 'hidden';
    // input.name = 'example';
    // input.value = 'value';
    // form.appendChild(input);

    document.body.appendChild(form);
    form.submit();

    // cleanup
    setTimeout(() => {
      form.remove();
    }, 1000);
  } catch (err) {
    console.error('openWithMethod error', err);
    alert('Failed to open URL — see console for details.');
  }
}
  function qsFromForm() {
    const f = document.getElementById('filters');
    if (!f) return '';
    const fd = new FormData(f);
    // NEW: include 'method' so pager links keep method filter
    const keep = ['q','http_class','codes','ctype','min_size','max_size','page_size','scheme','host','method'];
    const p = new URLSearchParams();
    keep.forEach(k => {
      const v = fd.get(k);
      if (v !== null && v !== '') p.set(k, v);
    });
    return p.toString();
  }
  function attachToPager(scope) {
    const root = scope || document;
    const qs = qsFromForm();
    if (!qs) return;
    root.querySelectorAll('#page .pager a[href]').forEach(a => {
      const href = a.getAttribute('href') || '';
      if (!href) return;
      const url = new URL(href, window.location.origin);
      const current = new URLSearchParams(url.search);
      qs.split('&').forEach(kv => {
        const [k, v] = kv.split('=');
        if (k) current.set(k, v);
      });
      url.search = current.toString();
      const out = url.pathname + (current.toString() ? '?' + current.toString() : '');
      a.setAttribute('href', out);
      a.setAttribute('hx-get', out);
    });
  }
  document.addEventListener('DOMContentLoaded', () => attachToPager(document));
  document.body.addEventListener('htmx:afterSwap', (ev) => {
    if (ev?.detail?.target?.id === 'page') attachToPager(ev.detail.target);
  });
})();
</script>
{% endblock %}
