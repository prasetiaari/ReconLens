{# app/templates/ai_command.html #}
{% extends "base.html" %}
{% block title %}AI Command · {{ scope }}{% endblock %}

{% block content %}
{% set active = "ai" %}
{% include "_target_tabs.html" with context %}
{% include "_ai_tabs.html" with context %}

{# Fallback: kalau thread_id kosong, ambil dari query string agar form tidak ikut-ikutan nonaktif #}
{% set active_thread = thread_id or request.query_params.get('thread') %}

<div class="mt-4">
  <h1 class="text-2xl font-semibold text-slate-900">
    AI Command for {{ scope }}
  </h1>
  <p class="mt-2 text-slate-600">
    Kirim prompt ke AI untuk membuat plan & menjalankan tools. Multi-thread dengan history.
  </p>
</div>

{# =======================
   LAYOUT: Sidebar (threads) + Main (chat)
   ======================= #}
<div class="mt-4 grid grid-cols-12 gap-4">
  <!-- Sidebar: Threads -->
  <aside class="col-span-12 md:col-span-3">
    <div class="rounded-lg border bg-white p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs uppercase tracking-wide text-slate-500">Threads</div>

        <!-- New Thread: POST -> JSON {ok, thread_id}; JS redirect ke ?thread=<id> -->
        <div class="inline-flex items-center gap-2" title="Create new thread">
          <input id="new-thread-title" class="input py-1 px-2 text-sm" placeholder="new thread title…"/>
          <button
            id="btn-new-thread"
            class="px-2 py-1 rounded bg-slate-900 text-white text-xs hover:bg-black"
            hx-post="/targets/{{ scope }}/ai/command/thread"
            hx-vals='js:{"title": document.getElementById("new-thread-title").value}'
            hx-target="#threads-list"
            hx-swap="outerHTML">
            New
          </button>
        </div>
      </div>

      <!-- daftar thread (selalu fresh) -->
      <div id="threads-list"
           hx-get="/targets/{{ scope }}/ai/command/thread_list"
           hx-trigger="load"
           hx-swap="outerHTML">
        <div class="text-sm text-slate-500">Loading…</div>
      </div>
    </div>
  </aside>

  <!-- Main: Chat -->
  <main class="col-span-12 md:col-span-9">
    <div class="rounded-lg border bg-white h-[72vh] flex flex-col">
      <!-- Header -->
      <div class="px-4 py-3 border-b flex items-center gap-4">
        <div class="text-sm">
          <span class="text-slate-500">Model</span>
          <select id="ai-model" class="input py-1 px-2 ml-1 align-middle">
            <option value="llama3.2:3b">llama3.2:3b</option>
            <option value="llama3.1:8b">llama3.1:8b</option>
            <option value="qwen2.5:3b">qwen2.5:3b</option>
          </select>
        </div>
        <div class="text-sm">
          <span class="text-slate-500">Intent</span>
          <select id="ai-intent" class="input py-1 px-2 ml-1 align-middle">
            <option value="auto" selected>auto</option>
            <option value="analyze">analyze</option>
            <option value="enumerate">enumerate</option>
            <option value="scan">scan</option>
          </select>
        </div>

        <div class="ml-auto text-sm text-slate-500">
          Thread: <span class="font-mono">{{ active_thread or "–" }}</span>
        </div>
      </div>

      <!-- Conversation (scrollable) -->
      <div id="ai-conversation"
           class="flex-1 overflow-auto p-4"
           {% if active_thread %}
             hx-get="/targets/{{ scope }}/ai/command/thread/{{ active_thread }}"
             hx-trigger="load"
             hx-swap="innerHTML"
           {% endif %}>
        {% if messages and messages|length %}
          {% include "_ai_cmd_messages.html" with context %}
        {% else %}
          <div class="text-sm text-slate-500">
            {% if active_thread %}No messages yet.{% else %}Create / pilih thread di kiri.{% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Composer (chat style, di bawah) -->
      <div class="border-t p-3">
        {% if active_thread %}
          <form id="aiPlanForm"
                class="flex items-start gap-2"
                hx-post="/targets/{{ scope }}/ai/command/thread/{{ active_thread }}/parse"
                hx-target="#ai-conversation"
                hx-swap="innerHTML"
                onsubmit="attachPlanFormParams(this);">
            <textarea name="prompt"
                      id="chat-input"
                      rows="1"
                      class="w-full input"
                      placeholder="Tulis perintah… (Enter = kirim, Shift+Enter = baris baru)"
                      required></textarea>

            <div class="flex items-center gap-2">
              <button type="submit"
                      class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700">
                Send
              </button>

              <button type="button"
                      id="aiRunBtn"
                      class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700"
                      hx-post="/targets/{{ scope }}/ai/command/thread/{{ active_thread }}/run"
                      hx-target="#ai-conversation"
                      hx-swap="innerHTML">
                ▶ Run Plan
              </button>

              <button type="button"
                      class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm hover:bg-slate-200"
                      hx-get="/targets/{{ scope }}/ai/command/thread/{{ active_thread }}"
                      hx-target="#ai-conversation"
                      hx-swap="innerHTML">
                Refresh
              </button>
            </div>

            <!-- hidden fields diisi dari dropdown header -->
            <input type="hidden" name="model" id="ai-model-hidden" value="llama3.2:3b" />
            <input type="hidden" name="intent" id="ai-intent-hidden" value="auto" />
          </form>
        {% else %}
          <div class="text-sm text-slate-500">Buat atau pilih thread untuk mulai chat.</div>
        {% endif %}
      </div>
    </div>
  </main>
</div>

{# =======================
   Helpers (UI only)
   ======================= #}
<script>
  // Pass model/intent ke hidden saat submit
  function attachPlanFormParams(form) {
    const m = document.getElementById('ai-model').value;
    const i = document.getElementById('ai-intent').value;
    document.getElementById('ai-model-hidden').value = m;
    document.getElementById('ai-intent-hidden').value = i;
  }

  // New thread: Enter to submit; redirect ke ?thread=<id> pada afterRequest
  (function () {
    const inp = document.getElementById('new-thread-title');
    const btn = document.getElementById('btn-new-thread');
    inp?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btn?.click(); }});
    document.body.addEventListener('htmx:afterRequest', (ev)=>{
      const elt = ev.target;
      if (!elt || elt.id !== 'btn-new-thread') return;
      try {
        const j = JSON.parse(ev.detail.xhr.responseText || '{}');
        if (j && j.ok && j.thread_id) {
          const u = new URL(location.href);
          u.searchParams.set('thread', j.thread_id);
          location.href = u.pathname + '?' + u.searchParams.toString();
        }
      } catch(_) {}
    });
  })();

  // Auto-scroll ke bawah tiap percakapan di-load / diperbarui
  document.body.addEventListener('htmx:afterSwap', (ev)=>{
    if (ev?.detail?.target?.id === 'ai-conversation') {
      const box = ev.detail.target;
      box.scrollTop = box.scrollHeight;
      // fokuskan input biar cepat ngetik lagi
      const t = document.getElementById('chat-input');
      t && t.focus();
    }
  });

  // Chat UX: Enter kirim, Shift+Enter baris baru
  document.addEventListener('keydown', (e)=>{
    const t = document.getElementById('chat-input');
    if (!t || document.activeElement !== t) return;
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const form = document.getElementById('aiPlanForm');
      form?.requestSubmit();
    }
  });
</script>
{% endblock %}
