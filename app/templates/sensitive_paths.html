{% extends "base.html" %}

{% block content %}
{% set active = "sensitive" %}
  {% include "_target_tabs.html" with context %}
<div class="flex items-center justify-between mb-6">
    
  <h1 class="text-2xl font-semibold">
    Sensitive Paths â€” <span class="font-mono text-slate-600">{{ scope }}</span>
  </h1>
  <a href="{{ page_url }}?download=1" class="text-blue-600 hover:underline">download raw</a>
</div>

<form id="filters"
      class="grid grid-cols-12 gap-4 items-end mb-4"
      hx-get="{{ page_url }}"
      hx-target="#page"
      hx-select="#page"
      hx-push-url="true">

  <div class="col-span-12 md:col-span-4">
    <label class="block text-sm text-slate-500 mb-1">Search</label>
    <input name="q" value="{{ q|default('') }}" placeholder="substring..." class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">HTTP Class</label>
    {% set hc = (http_class or '(any)') %}
    <select name="http_class" class="input w-full">
      <option value="(any)" {{ 'selected' if hc in ['(any)','any',''] else '' }}>(any)</option>
      <option value="2xx" {{ 'selected' if hc=='2xx' else '' }}>2xx</option>
      <option value="3xx" {{ 'selected' if hc=='3xx' else '' }}>3xx</option>
      <option value="4xx" {{ 'selected' if hc=='4xx' else '' }}>4xx</option>
      <option value="5xx" {{ 'selected' if hc=='5xx' else '' }}>5xx</option>
    </select>
  </div>

  <div class="col-span-6 md:col-span-3">
    <label class="block text-sm text-slate-500 mb-1">Exact Codes</label>
    <input name="codes" value="{{ codes|default('') }}" placeholder="comma-separated, overrides class" class="input w-full"/>
  </div>

  <div class="col-span-12 md:col-span-3">
    <label class="block text-sm text-slate-500 mb-1">Content-Type contains</label>
    <input name="ctype" value="{{ ctypes|default('') }}" placeholder="e.g. pdf,msword,zip" class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Min Size (bytes)</label>
    <input type="number" name="min_size" value="{{ min_size if min_size is not none else '' }}" class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">Max Size (bytes)</label>
    <input type="number" name="max_size" value="{{ max_size if max_size is not none else '' }}" class="input w-full"/>
  </div>

  <div class="col-span-6 md:col-span-2">
    <label class="block text-sm text-slate-500 mb-1">rows/page</label>
    {% set ps = page_size|int %}
    <select name="page_size" class="input w-full">
      {% for opt in [25,50,100,200] %}
      <option value="{{ opt }}" {{ 'selected' if ps==opt else '' }}>{{ opt }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-span-6 md:col-span-2 flex gap-3">
    <button class="btn btn-primary mt-6" type="submit">Apply</button>
    <a class="btn mt-6" href="{{ page_url }}">Reset</a>
  </div>
</form>

<div id="page"
     class="space-y-4"
     hx-boost="true"
     hx-target="#page"
     hx-select="#page"
     hx-include="#filters"
     hx-push-url="true">

  {% include "_pager.html" %}

  <div class="overflow-x-auto rounded border bg-white">
    <table class="w-full table-fixed border-separate border-spacing-0 rounded-xl overflow-hidden">
      <thead class="bg-slate-100 text-slate-700">
        <tr class="bg-slate-100 text-slate-600 text-sm">
          <th class="px-4 py-2 text-left w-[36ch]">URL</th>
          <th class="px-12 py-2 text-left">status</th>
          <th class="px-4 py-2 text-left">code</th>
          <th class="px-4 py-2 text-left">size</th>
          <th class="p-3 text-left max-w-[20ch]">title</th>
          <th class="px-4 py-2 text-left">last_probe</th>
          <th class="px-4 py-2 text-left">action</th>
        </tr>
      </thead>
      <tbody>
        {% include "_sensitive_paths_rows.html" %}
      </tbody>
    </table>
  </div>

  {% include "_pager.html" %}
</div>

<script>
(function () {
  function qsFromForm() {
    const f = document.getElementById('filters');
    if (!f) return '';
    const fd = new FormData(f);
    const keep = ['q','http_class','codes','ctype','min_size','max_size','page_size'];
    const p = new URLSearchParams();
    keep.forEach(k => {
      const v = fd.get(k);
      if (v !== null && v !== '') p.set(k, v);
    });
    return p.toString();
  }
  function attachToPager(scope) {
    const root = scope || document;
    const qs = qsFromForm();
    if (!qs) return;
    root.querySelectorAll('#page .pager a[href]').forEach(a => {
      const href = a.getAttribute('href') || '';
      if (!href) return;
      const url = new URL(href, window.location.origin);
      // preserve existing params AND override with current filter values
      const current = new URLSearchParams(url.search);
      qs.split('&').forEach(kv => {
        const [k,v] = kv.split('=');
        if (k) current.set(k, v);
      });
      url.search = current.toString();
      a.setAttribute('href', url.pathname + (url.search ? '?' + url.searchParams.toString() : ''));
      a.setAttribute('hx-get', url.pathname + '?' + current.toString());
    });
  }
  document.addEventListener('DOMContentLoaded', () => attachToPager(document));
  document.body.addEventListener('htmx:afterSwap', (ev) => {
    if (ev?.detail?.target?.id === 'page') attachToPager(ev.detail.target);
  });
})();
</script>
{% endblock %}
