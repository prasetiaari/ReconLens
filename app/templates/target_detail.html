{% extends "base.html" %}
{% block title %}{{ scope }} · Pentest URLs Viewer{% endblock %}
{% block content %}
{% set active = "overview" %}
  {% include "_target_tabs.html" with context %}
<h1 class="text-2xl font-semibold mb-1">{{ scope }}</h1>
<p class="text-sm text-slate-500 mb-6">
  Generated: {{ summary.generated_at or 'n/a' }}
</p>
<div class="grid">
    
{% include "_summary_cards.html" %}
</div><br>
{% if stats %}
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for st in stats %}
      <div class="p-4 rounded-xl bg-white shadow hover:shadow-md transition">
        <div class="flex items-start justify-between">
          <div class="space-y-1">
            <div class="text-sm uppercase tracking-wide text-slate-500">{{ st.module }}</div>
            <div class="text-2xl font-semibold">
              {{ "{:,}".format(st.lines) }}
              <span class="text-sm font-normal text-slate-400">lines</span>
            </div>
          </div>
          <div class="text-right text-xs text-slate-400">
            <div class="truncate max-w-[18ch]">{{ st.file }}</div>
            <div>{{ "{:,}".format(st.size_bytes) }} bytes</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          {% if st.module == "subdomains" %}
            <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
               href="/targets/{{ scope }}/subdomains">View</a>
          {% else %}
            <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
               href="/targets/{{ scope }}/{{ st.module }}">View</a>
          {% endif %}
          <a class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-sm"
             href="/targets/{{ scope }}/download/{{ st.file }}">Download</a>

          {% if st.lines == 0 %}
            <span class="ml-auto px-2 py-1 rounded bg-slate-100 text-slate-500 text-xs">empty</span>
          {% else %}
            <span class="ml-auto px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs">ready</span>
          {% endif %}
        </div>
        
        <!-- HTTP Status Overview -->
        <!--
<div class="rounded-xl border bg-white p-4 mt-4">
  <div class="flex items-center justify-between mb-3">
    <div>
      <div class="text-sm font-semibold text-slate-700">HTTP Status (overview)</div>
      <div id="http-status-meta" class="text-xs text-slate-500"></div>
    </div>
    <a class="text-sm text-blue-600 hover:underline"
       href="/targets/{{ scope }}/graphs/status-codes">View graphs →</a>
  </div>

  <div class="grid grid-cols-12 gap-4">
    <div class="col-span-12 md:col-span-5">
      <div class="relative h-[180px]">
        <canvas id="http-status-pie"></canvas>
      </div>
    </div>
    <div class="col-span-12 md:col-span-7">
      <div id="http-status-list" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(function(){
  const scope = {{ scope|tojson }};
  const api   = `/targets/${encodeURIComponent(scope)}/api/overview/status-codes.json`;

  const metaEl = document.getElementById('http-status-meta');
  const listEl = document.getElementById('http-status-list');
  const ctx    = document.getElementById('http-status-pie').getContext('2d');

  const order   = ['2xx','3xx','4xx','5xx','other'];
  const palette = {'2xx':'#16a34a','3xx':'#0ea5e9','4xx':'#f59e0b','5xx':'#ef4444','other':'#64748b'};
  let pie;

  fetch(api).then(r=>r.json()).then(data => {
    const totals = Object.fromEntries(order.map(k => [k, 0]));
    (data.items||[]).forEach(it => { totals[it.klass] = it.count || 0; });

    // meta
    metaEl.textContent = `records=${data.meta?.records ?? '-'} · source=${data.meta?.source ?? '-'}`;

    // list kartu kecil
    listEl.innerHTML = order.map(k => `
      <div class="rounded border p-3">
        <div class="text-xs uppercase tracking-wide text-slate-500">${k}</div>
        <div class="text-xl font-semibold" style="color:${palette[k]}">${totals[k]}</div>
      </div>
    `).join('');

    // pie
    const dataset = order.map(k => totals[k]);
    if (pie) pie.destroy();
    pie = new Chart(ctx, {
      type: 'pie',
      data: { labels: order, datasets: [{ data: dataset, backgroundColor: order.map(k => palette[k]) }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
    });
  }).catch(err => {
    metaEl.textContent = 'failed to load overview';
    console.error(err);
  });
})();
</script>
-->
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="p-6 rounded-xl bg-white shadow">
    <p class="text-slate-600">No module files found for this target.</p>
    <p class="text-slate-500 text-sm mt-2">Pastikan folder
      <code class="px-1 rounded bg-slate-100">outputs/{{ scope }}</code> berisi file seperti
      <code class="px-1 rounded bg-slate-100">subdomains.txt</code>, <code class="px-1 rounded bg-slate-100">documents.txt</code>, dll.
    </p>
  </div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
(() => {
  const scope = {{ scope|tojson }};
  const elStatus = document.getElementById('status-codes-chart');   // <canvas> yang kamu tempatkan di kartu "Top HTTP Status Codes"
  const elCtype  = document.getElementById('content-types-chart');  // <canvas> di kartu "Top Content-Types"
  const elLast   = document.getElementById('last-probe-text');      // <span> di kartu "Last probe"

  // Helper timeago sederhana
  function timeago(ts){
    if(!ts) return "-";
    const sec = Math.max(0, Math.floor(Date.now()/1000 - ts));
    const d = Math.floor(sec/86400);
    if (d>0) return d+"d ago";
    const h = Math.floor(sec/3600);
    if (h>0) return h+"h ago";
    const m = Math.floor(sec/60);
    if (m>0) return m+"m ago";
    return sec+"s ago";
  }

  // 1) Status codes (bar)
  fetch(`/targets/${encodeURIComponent(scope)}/api/overview/status-codes.json`)
    .then(r => r.json())
    .then(j => {
      if (!elStatus) return;
      const labels = j.items.map(it => String(it.code));
      const data   = j.items.map(it => it.count);
      if (!labels.length) { elStatus.replaceWith(document.createTextNode("No data")); return; }
      new Chart(elStatus.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'count', data }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
      });
    });

  // 2) Content-Types (bar)
  fetch(`/targets/${encodeURIComponent(scope)}/api/overview/content-types.json`)
    .then(r => r.json())
    .then(j => {
      if (!elCtype) return;
      const labels = j.items.map(it => it.content_type);
      const data   = j.items.map(it => it.count);
      if (!labels.length) { elCtype.replaceWith(document.createTextNode("No data")); return; }
      new Chart(elCtype.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'count', data }] },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
      });
    });

  // 3) Last probe (text)
  fetch(`/targets/${encodeURIComponent(scope)}/api/overview/last-probe.json`)
    .then(r => r.json())
    .then(j => {
      if (!elLast) return;
      elLast.textContent = timeago(j.last_probe_unixts || 0);
    });
})();
</script>

{% endblock %}
