{% extends "base.html" %}
{% block title %}{{ scope }} ¬∑ Pentest URLs Viewer{% endblock %}

{% block content %}
{% set active = "overview" %}
{% include "_target_tabs.html" with context %}

{# Toolbar kecil (muncul kalau sudah ada urls.txt) #}
{% if urls_count and urls_count > 0 %}
  <div class="max-w-6xl mx-auto mt-3 mb-4 flex items-center justify-between">
    <div class="text-sm text-slate-500">
      URL corpus: <span class="font-medium text-slate-700">{{ "{:,}".format(urls_count) }}</span> lines
    </div>
    <div class="flex items-center gap-4">
      <button id="rebuildBtn"   type="button" class="text-xs text-slate-500 hover:text-slate-700 hover:underline">
        (re)build modules
      </button>
      <button id="recollectBtn" type="button" class="text-xs text-blue-600 hover:underline">
        (re)collect
      </button>
      <button id="reprobeBtn"   type="button" class="text-xs text-rose-600 hover:underline">
        (re)probe
      </button>
    </div>
  </div>
{% endif %}
<!--
<div class="grid">
  {#% include "_summary_cards.html" with context %#}
</div>
-->

{#% include "_ai_suggestions.html" with context %}

{# Empty-state besar kalau belum ada urls.txt #}
{% if not urls_count or urls_count == 0 %}
  <div class="p-6 rounded-xl bg-white shadow border border-slate-200">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-lg font-semibold text-slate-800 mb-1">No URL corpus yet</div>
        <p class="text-slate-600">
          Belum ada file
          <code class="px-1 rounded bg-slate-100">outputs/{{ scope }}/urls.txt</code>.
          Kumpulkan URL untuk target ini menggunakan salah satu opsi di bawah.
        </p>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-3">
      <a class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm"
         href="/targets/{{ scope }}/collect/gau" target="_blank" rel="noopener">Collect with GAU</a>
      <a class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm"
         href="/targets/{{ scope }}/collect/waymore" target="_blank" rel="noopener">Collect with Waymore</a>
    </div>

    <div class="mt-3 text-xs text-slate-500">
      Tip: proses berjalan di tab baru; kamu tetap bisa menjelajah menu lain sambil menunggu.
    </div>
  </div>
{% endif %}

{# Banner "No module files yet" ‚Äî SEKARANG berbasis klasifikasi BARU #}
{% set new_modules = [
  'auth_login','admin_panel','api','upload','download_dump',
  'debug_dev','docs_swagger','config_backup_source','sensitive_functionality',
  'monitoring','payments','static_assets','file_disclosure','dirsearch','other','probe_paths'
] %}
{% set has_any_new = false %}
{% for st in stats %}
  {% if st.module in new_modules and st.lines > 0 %}
    {% set has_any_new = true %}
  {% endif %}
{% endfor %}

{% if urls_count and urls_count > 0 and (not has_modules) %}
  <div class="p-6 rounded-xl bg-white shadow border border-slate-200 mt-4">
    <div class="text-lg font-semibold text-slate-800 mb-1">No module files yet</div>
    <p class="text-slate-600">
      Kamu sudah punya <code class="px-1 rounded bg-slate-100">urls.txt</code>, tapi file-file klasifikasi baru belum dibuat.
      Jalankan proses (re)build untuk menghasilkan berkas:
      <code class="px-1 rounded bg-slate-100">auth_login.txt</code>,
      <code class="px-1 rounded bg-slate-100">admin_panel.txt</code>,
      <code class="px-1 rounded bg-slate-100">api.txt</code>,
      <code class="px-1 rounded bg-slate-100">‚Ä¶</code>,
      <code class="px-1 rounded bg-slate-100">other.txt</code>.
    </p>
    <div class="mt-4 flex flex-wrap gap-3">
      <button id="rebuildBtnSecondary"
              class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm">
        build modules
      </button>
      <a href="/targets/{{ scope }}" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">Refresh report</a>
    </div>
    <p class="mt-3 text-xs text-slate-500">
      Proses berjalan di tab baru; kamu bisa tetap memakai aplikasi ini.
    </p>
  </div>
{% endif %}

{# =========================
   CARDS
   ========================= #}
{% if stats %}
  {# ------- Subdomains (selalu ada) ------- #}
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
    {% set subd = None %}
    {% for st in stats %}
      {% if st.module == "subdomains" %}
        {% set subd = st %}
      {% endif %}
    {% endfor %}
    {% set sub = stats_map.get('subdomains') %}
    <div class="p-4 rounded-xl bg-white shadow hover:shadow-md transition">
      <div class="flex items-start justify-between">
        <div class="space-y-1">
          <div class="text-sm uppercase tracking-wide text-slate-500">subdomains</div>
          <div class="text-2xl font-semibold">
            {{ (sub.hosts if sub and sub.hosts is not none else (sub.lines if sub else 0)) }}
            <span class="text-sm font-normal text-slate-400">hosts</span>
          </div>
          <p class="text-xs text-slate-500">
              Last scan: {{ (dash.get('last_scans') or {}).get('subdomains', '-')[:19] }}
            </p>
        </div>
        <div class="text-right text-xs text-slate-400">
          <div class="truncate max-w-[18ch]">subdomains.txt</div>
          <div>{{ "{:,}".format((sub.size_bytes if sub else 0) | int) }} bytes</div>
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
           href="/targets/{{ scope }}/subdomains">View</a>
        <a class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-sm"
           href="/targets/{{ scope }}/download/subdomains.txt">Download</a>
          <a class="px-3 py-1.5 rounded-lg bg-red-400 text-white text-sm"
             href="/targets/{{ scope }}/collect/probe_subdomains"
             target="_blank" rel="noopener">
             üåê Probe
          </a>
        <!--{% if (subd and subd.lines > 0) %}
          <span class="ml-auto px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs">ready</span>
        {% else %}
          <span class="ml-auto px-2 py-1 rounded bg-slate-100 text-slate-500 text-xs">empty</span>
        {% endif %}-->
      </div>
    </div>
  </div>

  {# ------- Discovery Modules (Dirsearch & Probe Paths) ------- #}
  {% set dir_mod = stats_map.get('dirsearch') %}
  {% set ppaths  = stats_map.get('probe_paths') %}

  {% if dir_mod or ppaths %}
    <h3 class="mt-6 mb-2 text-slate-700 font-semibold">Discovery Modules</h3>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {% if dir_mod %}
        <div class="p-4 rounded-xl bg-white shadow hover:shadow-md transition border border-blue-100">
          <div class="flex items-start justify-between">
            <div class="space-y-1">
              <div class="text-sm uppercase tracking-wide text-blue-600 flex items-center gap-2">
                <span>DIRSEARCH</span> <span class="text-[11px] px-2 py-0.5 rounded bg-blue-50 text-blue-700">Discovery</span>
              </div>
              <div class="text-2xl font-semibold">
                {{ "{:,}".format(dir_mod.lines or 0) }}
                <span class="text-sm font-normal text-slate-400">lines</span>
              </div>
              <p class="text-xs text-slate-500">
                Last scan: {{ (dash.last_scans.get('dirsearch') or '-')[:19] }}
              </p>
            </div>
            <div class="text-right text-xs text-slate-400">
              <div class="truncate max-w-[18ch]">{{ dir_mod.file }}</div>
              <div>{{ "{:,}".format(dir_mod.size_bytes or 0) }} bytes</div>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <!--<a class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm"
               href="/targets/{{ scope }}/collect/probe_module?module=dirsearch"
               target="_blank" rel="noopener">‚ñ∂ Run</a>-->
            <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
               href="/targets/{{ scope }}/dirsearch">View</a>
            <a class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-sm"
               href="/targets/{{ scope }}/download/{{ dir_mod.file }}">Download</a>
            <!--{% if dir_mod.lines and dir_mod.lines > 0 %}
              <span class="ml-auto px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs">ready</span>
            {% else %}
              <span class="ml-auto px-2 py-1 rounded bg-slate-100 text-slate-500 text-xs">empty</span>
            {% endif %}-->
          </div>
        </div>
      {% endif %}

      {% if ppaths %}
        <div class="p-4 rounded-xl bg-white shadow hover:shadow-md transition border border-teal-100">
          <div class="flex items-start justify-between">
            <div class="space-y-1">
              <div class="text-sm uppercase tracking-wide text-teal-600 flex items-center gap-2">
                <span>PROBE_PATHS</span> <span class="text-[11px] px-2 py-0.5 rounded bg-teal-50 text-teal-700">Custom Probe</span>
              </div>
              <div class="text-2xl font-semibold">
                {{ "{:,}".format(ppaths.lines or 0) }}
                <span class="text-sm font-normal text-slate-400">lines</span>
              </div>
              <p class="text-xs text-slate-500">
                Last scan: {{ (dash.last_scans.get('probe_paths') or '-')[:19] }}
              </p>
            </div>
            <div class="text-right text-xs text-slate-400">
              <div class="truncate max-w-[18ch]">{{ ppaths.file }}</div>
              <div>{{ "{:,}".format(ppaths.size_bytes or 0) }} bytes</div>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <!--<a class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm"
               href="/targets/{{ scope }}/collect/probe_module?module=probe_paths"
               target="_blank" rel="noopener">‚ñ∂ Run</a>-->
            <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
               href="/targets/{{ scope }}/probe_paths">View</a>
            <a class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-sm"
               href="/targets/{{ scope }}/download/{{ ppaths.file }}">Download</a>
            <!--{% if ppaths.lines and ppaths.lines > 0 %}
              <span class="ml-auto px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs">ready</span>
            {% else %}
              <span class="ml-auto px-2 py-1 rounded bg-slate-100 text-slate-500 text-xs">empty</span>
            {% endif %}-->
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  {# ------- Categorized Findings (exclude discovery modules) ------- #}
  {% if stats %}
    <h3 class="mt-6 mb-2 text-slate-700 font-semibold">Categorized Findings</h3>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {% set order = [
        'auth_login','admin_panel','api','upload','download_dump',
        'debug_dev','docs_swagger','config_backup_source','sensitive_functionality',
        'monitoring','payments','static_assets','file_disclosure','other'
      ] %}

      {% for key in order %}
        {% for st in stats if st.module == key and st.lines > 0 %}
          <div class="p-4 rounded-xl bg-white shadow hover:shadow-md transition">
            <div class="flex items-start justify-between">
              <div class="space-y-1">
                <div class="text-sm uppercase tracking-wide text-slate-500">{{ st.module }}</div>
                <div class="text-2xl font-semibold">
                  {{ "{:,}".format(st.lines) }}
                  <span class="text-sm font-normal text-slate-400">lines</span>
                </div>
                <p class="text-xs text-slate-500">
                  Last probe: {{ (dash.last_scans.get(st.module) or '-')[:19] }}
                </p>
              </div>
              <div class="text-right text-xs text-slate-400">
                <div class="truncate max-w-[18ch]">{{ st.file }}</div>
                <div>{{ "{:,}".format(st.size_bytes) }} bytes</div>
              </div>
            </div>

            <div class="mt-4 flex gap-2">
              <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
                 href="/targets/{{ scope }}/{{ st.module }}">View</a>
              <a class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-sm"
                 href="/targets/{{ scope }}/download/{{ st.file }}">Download</a>
              {# üîç Tombol Probe (dinamis per module) #}
              <a class="px-3 py-1.5 rounded-lg bg-red-400 text-white text-sm"
                 href="/targets/{{ scope }}/collect/probe_module?module={{ st.module }}"
                 target="_blank" rel="noopener">
                 üîç Probe
              </a>
              <!--<span class="ml-auto px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs">ready</span>-->
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  {% endif %}
{% else %}
  <div class="p-6 rounded-xl bg-white shadow mt-4">
    <p class="text-slate-600">No module files found for this target.</p>
  </div>
{% endif %}

{# =========================
   MODALS
   ========================= #}

<!-- (re)collect modal -->
<div id="recollectModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-28 w-[92%] max-w-md rounded-xl bg-white shadow-lg border border-slate-200">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Choose collector</div>
      <button id="recollectClose" class="text-slate-400 hover:text-slate-600" aria-label="Close">‚úï</button>
    </div>
    <div class="p-5 space-y-3 text-sm">
      <p class="text-slate-600">
        Jalankan pengumpulan URL untuk <span class="font-mono">{{ scope }}</span>:
      </p>
      <div class="flex flex-wrap gap-2">
        <a href="/targets/{{ scope }}/collect/gau" target="_blank" rel="noopener"
           class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">GAU</a>
        <a href="/targets/{{ scope }}/collect/waymore" target="_blank" rel="noopener"
           class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">Waymore</a>
      </div>
      <p class="text-xs text-slate-500">
        Proses berjalan di tab baru; kamu bisa tetap memakai aplikasi ini.
      </p>
    </div>
  </div>
</div>

<!-- (re)build modules modal -->
<div id="rebuildModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-28 w-[92%] max-w-md rounded-xl bg-white shadow-lg border border-slate-200">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Build modules</div>
      <button id="rebuildClose" class="text-slate-400 hover:text-slate-600" aria-label="Close">‚úï</button>
    </div>
    <div class="p-5 space-y-3 text-sm">
      <p class="text-slate-600">
        Jalankan proses klasifikasi URL menjadi file-file modul untuk
        <span class="font-mono">{{ scope }}</span>.
      </p>
      <div class="flex flex-wrap gap-2">
        <a href="/targets/{{ scope }}/collect/build" target="_blank" rel="noopener"
           class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">Run (re)build</a>
      </div>
      <p class="text-xs text-slate-500">
        Ini akan memanggil ReconLens CLI dan memperbarui file modul di <code>outputs/{{ scope }}/</code>.
      </p>
    </div>
  </div>
</div>

<!-- (re)probe modal (Active scan) -->
<div id="reprobeModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-24 w-[92%] max-w-lg rounded-xl bg-white shadow-lg border border-slate-200">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Run probes (active)</div>
      <button id="reprobeClose" class="text-slate-400 hover:text-slate-600" aria-label="Close">‚úï</button>
    </div>
    <div class="p-5 space-y-4 text-sm">
      <div class="rounded-lg border border-rose-200 bg-rose-50 p-3 text-rose-700">
        ‚ö†Ô∏è <strong>Active scanning:</strong> Probing akan mengirim request HTTP ke target.
        Ini bisa memakan waktu lama dan menghasilkan traffic besar. Pastikan kamu berizin.
      </div>

      <div class="space-y-2">
        <div class="text-slate-700 font-medium">Scope</div>
        <label class="flex items-center gap-2">
          <input type="radio" name="probe_scope" value="all" checked class="accent-rose-600">
          <span>Probe <span class="font-mono">{{ "{:,}".format(urls_count or 0) }}</span> URLs (all corpus)</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="probe_scope" value="module" class="accent-rose-600">
          <span>Probe by module</span>
        </label>
        <div id="probeModuleWrap" class="mt-2 ml-6 hidden">
          <select id="probeModuleSel" class="input w-full">
            {% for st in stats %}
              <option value="{{ st.module }}">{{ st.module }} ({{ st.lines }} lines)</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <label class="flex items-start gap-2">
        <input id="probeAgree" type="checkbox" class="mt-1 accent-rose-600">
        <span class="text-slate-600">Saya paham ini adalah active scan dan saya memiliki izin untuk melakukannya.</span>
      </label>

      <div class="flex items-center justify-end gap-2 pt-2">
        <button id="probeRun" disabled
                class="px-3 py-2 rounded-lg bg-rose-600 text-white text-sm disabled:opacity-50">
          Run probe
        </button>
        <button id="reprobeClose2" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">
          Cancel
        </button>
      </div>

      <p class="text-xs text-slate-500">
        Catatan: sementara tautan akan membuka tab baru (endpoint placeholder).
      </p>
    </div>
  </div>
</div>

<script>
(function(){
  function bindModal(openBtnId, modalId, closeBtnId){
    const modal   = document.getElementById(modalId);
    const openBtn = document.getElementById(openBtnId);
    const closeBtn= document.getElementById(closeBtnId);

    function open(){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
    function close(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }

    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);

    modal?.addEventListener('click', (e)=>{
      if (e.target === modal || (e.target.classList && e.target.classList.contains('bg-black/40'))) close();
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
    });
    return { open, close, modal };
  }

  // collect & build
  bindModal('recollectBtn',       'recollectModal', 'recollectClose');
  bindModal('rebuildBtn',         'rebuildModal',   'rebuildClose');
  bindModal('rebuildBtnSecondary','rebuildModal',   'rebuildClose');

  // probe
  const { modal: probeModal } = bindModal('reprobeBtn','reprobeModal','reprobeClose');
  document.getElementById('reprobeClose2')?.addEventListener('click', ()=> {
    probeModal.classList.add('hidden'); probeModal.setAttribute('aria-hidden','true');
  });

  const scope = {{ scope|tojson }};
  const agree = document.getElementById('probeAgree');
  const runBtn= document.getElementById('probeRun');
  const modWrap = document.getElementById('probeModuleWrap');
  const modSel  = document.getElementById('probeModuleSel');

  function updateEnable(){
    runBtn.disabled = !agree.checked;
  }
  agree?.addEventListener('change', updateEnable);
  updateEnable();

  // toggle module dropdown
  Array.from(document.querySelectorAll('input[name="probe_scope"]')).forEach(r => {
    r.addEventListener('change', ()=>{
      modWrap.classList.toggle('hidden', r.value !== 'module' || !r.checked);
    });
  });

  // Placeholder action: open new tab sesuai pilihan (endpoint belum diimplement)
  runBtn?.addEventListener('click', ()=>{
    const scopeChoice = document.querySelector('input[name="probe_scope"]:checked')?.value || 'all';
    if (scopeChoice === 'module') {
      const m = modSel?.value || 'other';
      window.open(`/targets/${encodeURIComponent(scope)}/probe/module/${encodeURIComponent(m)}`, '_blank');
    } else {
      window.open(`/targets/${encodeURIComponent(scope)}/probe/all`, '_blank');
    }
  });
})();
</script>

{% endblock %}
