{% extends "base.html" %}
{% block title %}{{ scope }} · Pentest URLs Viewer{% endblock %}

{% block content %}
{% set active = "overview" %}
{% include "_target_tabs.html" with context %}

{# Toolbar kecil (muncul kalau sudah ada urls.txt) #}
{% if urls_count and urls_count > 0 %}
  <div class="max-w-6xl mx-auto mt-3 mb-4 flex items-center justify-between">
    <div class="text-sm text-slate-500">
      URL corpus: <span class="font-medium text-slate-700">{{ "{:,}".format(urls_count) }}</span> lines
    </div>
    <div class="flex items-center gap-4">
      <button id="rebuildBtn"   type="button" class="text-xs text-slate-500 hover:text-slate-700 hover:underline">
        (re)build modules
      </button>
      <button id="recollectBtn" type="button" class="text-xs text-blue-600 hover:underline">
        (re)collect
      </button>
    </div>
  </div>
{% endif %}

<div class="grid">
  {% include "_summary_cards.html" %}
</div>
<br>

{# Empty-state besar kalau belum ada urls.txt #}
{% if not urls_count or urls_count == 0 %}
  <div class="p-6 rounded-xl bg-white shadow border border-slate-200">
    <div class="flex items-start justify-between gap-4">
      <div>
        <div class="text-lg font-semibold text-slate-800 mb-1">No URL corpus yet</div>
        <p class="text-slate-600">
          Belum ada file
          <code class="px-1 rounded bg-slate-100">outputs/{{ scope }}/urls.txt</code>.
          Kumpulkan URL untuk target ini menggunakan salah satu opsi di bawah.
        </p>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-3">
      <a class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm"
         href="/targets/{{ scope }}/collect/gau" target="_blank" rel="noopener">Collect with GAU</a>
      <a class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm"
         href="/targets/{{ scope }}/collect/waymore" target="_blank" rel="noopener">Collect with Waymore</a>
    </div>

    <div class="mt-3 text-xs text-slate-500">
      Tip: proses berjalan di tab baru; kamu tetap bisa menjelajah menu lain sambil menunggu.
    </div>
  </div>
{% endif %}

{# Banner "No module files yet" jika urls.txt ADA tapi modul kosong #}
{% set total_module_lines = (stats | map(attribute='lines') | sum) | default(0) %}
{% if urls_count and urls_count > 0 and total_module_lines == 0 %}
  <div class="p-6 rounded-xl bg-white shadow border border-slate-200 mt-4">
    <div class="text-lg font-semibold text-slate-800 mb-1">No module files yet</div>
    <p class="text-slate-600">
      Kamu sudah punya <code class="px-1 rounded bg-slate-100">urls.txt</code>, tapi file-file modul belum dibuat.
      Jalankan proses klasifikasi untuk membangun berkas modul
      (<code class="px-1 rounded bg-slate-100">sensitive_paths.txt</code>,
      <code class="px-1 rounded bg-slate-100">open_redirect.txt</code>,
      <code class="px-1 rounded bg-slate-100">documents.txt</code>, dll).
    </p>
    <div class="mt-4 flex flex-wrap gap-3">
      <button id="rebuildBtnSecondary"
              class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm">
        (re)build modules
      </button>
      <a href="/targets/{{ scope }}" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">Refresh report</a>
    </div>
    <p class="mt-3 text-xs text-slate-500">
      Proses berjalan di tab baru; kamu bisa tetap memakai aplikasi ini.
    </p>
  </div>
{% endif %}

{% if stats %}
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
    {% for st in stats %}
      <div class="p-4 rounded-xl bg-white shadow hover:shadow-md transition">
        <div class="flex items-start justify-between">
          <div class="space-y-1">
            <div class="text-sm uppercase tracking-wide text-slate-500">{{ st.module }}</div>
            <div class="text-2xl font-semibold">
              {{ "{:,}".format(st.lines) }}
              <span class="text-sm font-normal text-slate-400">lines</span>
            </div>
          </div>
          <div class="text-right text-xs text-slate-400">
            <div class="truncate max-w-[18ch]">{{ st.file }}</div>
            <div>{{ "{:,}".format(st.size_bytes) }} bytes</div>
          </div>
        </div>

        <div class="mt-4 flex gap-2">
          {% if st.module == "subdomains" %}
            <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
               href="/targets/{{ scope }}/subdomains">View</a>
          {% else %}
            <a class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm"
               href="/targets/{{ scope }}/{{ st.module }}">View</a>
          {% endif %}
          <a class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-sm"
             href="/targets/{{ scope }}/download/{{ st.file }}">Download</a>

          {% if st.lines == 0 %}
            <span class="ml-auto px-2 py-1 rounded bg-slate-100 text-slate-500 text-xs">empty</span>
          {% else %}
            <span class="ml-auto px-2 py-1 rounded bg-emerald-50 text-emerald-700 text-xs">ready</span>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="p-6 rounded-xl bg-white shadow mt-4">
    <p class="text-slate-600">No module files found for this target.</p>
  </div>
{% endif %}

{# =========================
   MODALS
   ========================= #}

<!-- (re)collect modal -->
<div id="recollectModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-28 w-[92%] max-w-md rounded-xl bg-white shadow-lg border border-slate-200">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Choose collector</div>
      <button id="recollectClose" class="text-slate-400 hover:text-slate-600" aria-label="Close">✕</button>
    </div>
    <div class="p-5 space-y-3 text-sm">
      <p class="text-slate-600">
        Jalankan pengumpulan URL untuk <span class="font-mono">{{ scope }}</span>:
      </p>
      <div class="flex flex-wrap gap-2">
        <a href="/targets/{{ scope }}/collect/gau" target="_blank" rel="noopener"
           class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">GAU</a>
        <a href="/targets/{{ scope }}/collect/waymore" target="_blank" rel="noopener"
           class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm">Waymore</a>
      </div>
      <p class="text-xs text-slate-500">
        Proses berjalan di tab baru; kamu bisa tetap memakai aplikasi ini.
      </p>
    </div>
  </div>
</div>

<!-- (re)build modules modal -->
<div id="rebuildModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto mt-28 w-[92%] max-w-md rounded-xl bg-white shadow-lg border border-slate-200">
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="text-sm font-semibold text-slate-800">Build modules</div>
      <button id="rebuildClose" class="text-slate-400 hover:text-slate-600" aria-label="Close">✕</button>
    </div>
    <div class="p-5 space-y-3 text-sm">
      <p class="text-slate-600">
        Jalankan proses klasifikasi URL menjadi file-file modul untuk
        <span class="font-mono">{{ scope }}</span>.
      </p>
      <div class="flex flex-wrap gap-2">
        <a href="/targets/{{ scope }}/rebuild" target="_blank" rel="noopener"
           class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">Run (re)build</a>
      </div>
      <p class="text-xs text-slate-500">
        Ini akan memanggil ReconLens CLI dan memperbarui file modul di <code>outputs/{{ scope }}/</code>.
      </p>
    </div>
  </div>
</div>

<script>
(function(){
  function bindModal(openBtnId, modalId, closeBtnId){
    const modal   = document.getElementById(modalId);
    const openBtn = document.getElementById(openBtnId);
    const closeBtn= document.getElementById(closeBtnId);

    function open(){ modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false'); }
    function close(){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }

    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);

    modal?.addEventListener('click', (e)=>{
      if (e.target === modal || (e.target.classList && e.target.classList.contains('bg-black/40'))) close();
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) close();
    });
  }

  bindModal('recollectBtn',       'recollectModal', 'recollectClose');
  bindModal('rebuildBtn',         'rebuildModal',   'rebuildClose');
  bindModal('rebuildBtnSecondary','rebuildModal',   'rebuildClose');
})();
</script>

{% endblock %}
